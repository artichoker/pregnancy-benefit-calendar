<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>産前産後休務カレンダー</title>
    <script type="text/javascript" src="js/prototype.js"></script>
    <script type="text/javascript" src="js/scriptaculous.js"></script>
    <script type="text/javascript" src="js/datefunc.js"></script>
    <style type="text/css">
        label.column1 {
            width: 140px;
            font-weight: bold;
            display: block;
            float: left;
            text-align: right;
        }
        
        div.column1 {
            padding: 6px;
            margin-top: 18px;
            font-size: 90%;
            /*border:1px dotted #999;*/
        }
        
        div.row {
            padding: 5px;
            margin-bottom: 4px;
        }
        
        .column2 {
            padding: 4px;
            margin: 4px;
        }
        
        span.date {
            padding: 2px;
            font-weight: bold;
            margin: 1px 4px 1px 4px;
        }
        
        label#boforeholsLabel {
            /* 産前休暇ラベル */
            margin: 0;
            padding: 4px;
            background-color: #FFD700;
        }
        
        label#afterholsLabel {
            /* 産後休暇ラベル */
            margin: 0;
            padding: 4px;
            background-color: #90EE90;
        }
        
        div#beforeHolsMessage span.date {
            padding: 0px;
            font-weight: bold;
            margin: 0px;
            background-color: #FCF;
        }
        
        div#afterHolsMessage span.date {
            padding: 0px;
            font-weight: bold;
            margin: 0px;
            background-color: #CFC;
        }
        
        div#inputArea {
            width: 500px;
            border: 1px solid #999;
            padding: 10px;
            background-color: #CDF
        }
        
        div#inputArea p {
            margin: 4px 0 6px 0;
        }
        
        div#messageArea {
            width: 500px;
            border: 1px solid #999;
            margin-top: 4px;
            padding: 10px;
        }
        
        div#calendar {
            margin: 20px 4px 20px 4px;
            background-color: #FFF;
        }
        
        table.calendar {
            text-align: right;
            float: left;
            margin-left: 6px;
            font-family: 'andale mono', 'Courier New', Monaco, monospace;
        }
        
        table.calendar th {
            font-size: 90%;
            text-align: center;
            background-color: #EDEDED;
        }
        
        table.calendar .sat {
            color: blue;
        }
        
        table.calendar .sun {
            color: red;
        }
        
        table.calendar td {
            background-color: #F3F3F3;
            font-size: 95%;
            width: 18px;
            height: 20px;
            border: 0;
            color: #333;
            text-align: center;
            vertical-align: middle;
            margin: 0;
            padding: 1;
        }
        
        a:link,
        a:visited,
        a:hover,
        a:active {
            color: #FFF;
            text-decoration: none;
            font-size: 90%;
            font-size: 90%;
            margin: 4px;
            font-weight: bold;
            border-bottom: 1px solid #036;
            border-right: 1px solid #036;
            padding: 4px;
            display: block;
            width: 160px;
        }
        
        a#myButton {
            background-color: #369;
        }
        
        .alert {
            color: red;
            font-weight: bold;
        }
        
        .style1 {
            font-size: 12px
        }
    </style>
    <script type="text/javascript">
        //<![CDATA[

        function setYearSelectOptions(e, r, dv) {
            d = (new Date()).getFullYear();
            if (isNaN(dv)) dv = d;
            fillSelectOptions(e, r * 2 + 1, d - r, d + r, dv);
        }

        function setDaySelectOptions(e, dv) {
            var date;
            if (e == 'dueDay') {
                date = $F('dueYear') + "/" + $F('dueMonth') + "/1";
            } else {
                date = $F('deliveryYear') + "/" + $F('deliveryMonth') + "/1";
            }
            var eday = ((EDate(date, 'yyyy/m/d')).split('/'))[2];
            if (isNaN(dv)) {
                dv = (parseInt($F(e), 10) > parseInt(eday, 10)) ? eday : $F(e)
            } else {
                dv = (parseInt(dv, 10) > parseInt(eday, 10)) ? eday : dv;
            }
            fillSelectOptions(e, eday, 1, eday, dv);
        }

        function fillSelectOptions(e, len, sv, ev, dv) {
            $(e).length = 0;
            $(e).length = len;
            i = 0;
            for (var v = sv; v <= ev; v++) {
                var flag = (v == dv) ? true : false;
                $(e).options[i] = new Option(v, v, flag, flag);
                i++;
            }
        }

        function toggleDeliveryDateSameAsDueDate() {
            if ($('sameAsDueDate').checked) {
                setYearSelectOptions('deliveryYear', 1, $F('dueYear'));
                fillSelectOptions('deliveryMonth', 12, 1, 12, $F('dueMonth'));
                setDaySelectOptions('deliveryDay', $F('dueDay'));
                $('deliveryYear').disabled = true;
                $('deliveryMonth').disabled = true;
                $('deliveryDay').disabled = true;
            } else {
                $('deliveryYear').disabled = false;
                $('deliveryMonth').disabled = false;
                $('deliveryDay').disabled = false;
            }
        }

        function initForm() {
            setYearSelectOptions('dueYear', 1);
            setYearSelectOptions('deliveryYear', 1);
            fillSelectOptions('dueMonth', 12, 1, 12, (new Date()).getMonth() + 1);
            fillSelectOptions('deliveryMonth', 12, 1, 12, (new Date()).getMonth() + 1);
            setDaySelectOptions('dueDay', (new Date()).getDate() + 1);
            setDaySelectOptions('deliveryDay', (new Date()).getDate() + 1);
            $('beforeHols').innerHTML = "&nbsp;";
            $('afterHols').innerHTML = "&nbsp;";
            toggleDeliveryDateSameAsDueDate();
            //calcHols();
            //Event.observe('myForm','change',calcHols);
        }

        function calcHols() {
            var beforeHolsStartDate;
            var beforeHolsEndDate;
            var afterHolsStartDate;
            var afterHolsEndDate;
            var noPayStartDate;

            var beforeHolsWeeks;
            var afterHolsDays;

            var calendar = "";

            var deliveryTermClass = 0;
            //  2=over 1 week 
            //  1=over and within 1week
            //  0=Just
            // -1=before and within 6weeks
            // -2=before 6weeks  
            // -3=before 4months

            beforeHolsWeeks = $('multiDelivery').checked ? 14 : 6;
            afterHolsWeeks = 8;

            beforeHolsStartDate = DateAdd('d', -7 * beforeHolsWeeks + 1, getDueDate("/"), "yyyy/mm/dd");
            beforeHolsEndDate = getDeliveryDate("/");

            afterHolsStartDate = DateAdd('d', 1, getDeliveryDate("/"), "yyyy/mm/dd");
            afterHolsEndDate = DateAdd('d', 7 * afterHolsWeeks - 1, afterHolsStartDate, "yyyy/mm/dd");

            var calStart = beforeHolsStartDate.split("/");
            var calEnd = afterHolsEndDate.split("/");

            //例外メッセージの表示
            hideMessage('beforeHolsMessage');
            hideMessage('afterHolsMessage');
            diff = parseInt(DateDiff('d', getDueDate("/"), getDeliveryDate("/")), 10);
            if (diff > 30) {
                alert("日付エラーです。計算を中断します。(" + diff + ")");
                hideMessageArea();
                return null;
            } else if (diff < -280) {
                alert("日付エラーです。計算を中断します。(" + diff + ")");
                hideMessageArea();
                return null;
            }

            var mess = "";
            if (diff > 7) { //予定日より1週間以上遅れた場合
                noPayStartDate = DateAdd('d', 8, getDueDate("/"), "yyyy/mm/dd");
                noPayEndDate = getDeliveryDate("/");

                mess = '出産日が予定日より1 週間以上遅れた場合は、1週間を超える期間(<span class="date">';
                if (noPayStartDate == noPayEndDate) {
                    mess += toJ(noPayStartDate) + "<\/span>)については無給となります。";
                } else {
                    mess += toJ(noPayStartDate) + "から" + toJ(noPayEndDate) + "<\/span>)については無給となります。";
                }
                showMessage('beforeHolsMessage', mess);

            } else if (parseInt(DateDiff('d', beforeHolsStartDate, getDeliveryDate("/")), 10) < 0) {

                if (diff < -7 * 4 * 7) { //4ヶ月未満
                    deliveryTermClass = -3;
                    beforeHolsStartDate = getDeliveryDate("/");
                    beforeHolsEndDate = getDeliveryDate("/");
                    //産後休暇は6週間で医師が必要と認めた期間
                    afterHolsEndDate = DateAdd('d', 7 * (afterHolsWeeks - 2) - 1, afterHolsStartDate, "yyyy/mm/dd");
                    mess = "妊娠４カ月未満で早産、流産や人工妊娠中絶を行ったときは、<span style='background-color:#FA8072;'>その当日<\/span>を産前休暇として取ることができます。";
                    mess += "また、その日から<span style='background-color:#00BFFF;'>６週間以内で医師が必要と認めた期間<\/span>を産後休暇として取ることができます。"
                    showMessage('afterHolsMessage', mess);
                } else if (diff <= 7 * 6 * -1) { //４カ月以後、6週間より前
                    deliveryTermClass = -2;
                    beforeHolsWeeks = 6; //多胎の場合でも単胎と同じになる
                    beforeHolsStartDate = DateAdd('d', -7 * beforeHolsWeeks + 1, getDeliveryDate("/"), "yyyy/mm/dd");
                    beforeHolsEndDate = getDeliveryDate("/");
                    mess = "妊娠４カ月から予定日の６週間前になるまでに出産したときは";
                    mess += "<span style='background-color:#FA8072;'>出産当日と出産日前で医師が休養を必要と認めた期間（最大６週間）<\/span>";
                    mess += "を産前休暇として取ることができます。"
                    showMessage('afterHolsMessage', mess);
                }
                //カレンダー表示期間の調整
                calStart = beforeHolsStartDate.split("/");
                calEnd = getDueDate("/").split("/");
            }

            if (deliveryTermClass == -3) {
                $('beforeHols').innerHTML = '<span class="date">' + toJ(beforeHolsStartDate) + '<\/span>';
            } else if (deliveryTermClass == -2) {
                $('beforeHols').innerHTML = '<span class="date">' + toJ(beforeHolsStartDate) + "～" + toJ(beforeHolsEndDate) + '<\/span>';
            } else {
                $('beforeHols').innerHTML = '<span class="date">' + toJ(beforeHolsStartDate) + "～" + toJ(beforeHolsEndDate) + '<\/span>';
            }
            $('afterHols').innerHTML = '<span class="date">' + toJ(afterHolsStartDate) + "～" + toJ(afterHolsEndDate) + '<\/span>';

            //カレンダー表示
            var caldiff = parseInt((calEnd[0] - calStart[0]) * 12, 10) + parseInt(calEnd[1], 10) - parseInt(calStart[1], 10);
            for (var i = 0; i <= caldiff; i++) {
                calendar += getCalendar(calStart[0], calStart[1], i);
                calStart[1]++;
                if (calStart[1] > 12) {
                    calStart[0]++;
                    calStart[1] = 1
                }
            }
            $('calendar').innerHTML = calendar + "<div style='clear:both'><\/div>";

            showMessageArea();

            //出産日をマーク
            var delId = getDeliveryDate("");
            $(delId).style.borderColor = "#F00";
            $(delId).style.borderWidth = "3px";
            $(delId).style.borderStyle = "solid";
            $(delId).style.fontWeight = "bold";
            //出産予定日をマーク
            var dueId = getDueDate("");
            $(dueId).style.borderColor = "#FF8C00";
            $(dueId).style.borderWidth = "3px";
            $(dueId).style.borderStyle = "solid";
            $(dueId).style.fontWeight = "bold";

            if (deliveryTermClass < -2) {
                //産前休暇をマーク
                markCalendar(beforeHolsStartDate, beforeHolsEndDate, "#FA8072");
                $('boforeholsLabel').style.backgroundColor = "#FA8072";
                //産後休暇をマーク
                markCalendar(afterHolsStartDate, afterHolsEndDate, "#00BFFF");
                $('afterholsLabel').style.backgroundColor = "#00BFFF";
            } else if (deliveryTermClass < -1) {
                //産前休暇をマーク
                markCalendar(beforeHolsStartDate, beforeHolsEndDate, "#FA8072");
                $('boforeholsLabel').style.backgroundColor = "#FA8072";
                //産後休暇をマーク
                markCalendar(afterHolsStartDate, afterHolsEndDate, "#90EE90");
                $('afterholsLabel').style.backgroundColor = "#90EE90";
            } else {
                //産前休暇をマーク
                markCalendar(beforeHolsStartDate, beforeHolsEndDate, "#FFD700");
                $('boforeholsLabel').style.backgroundColor = "#FFD700";
                //産後休暇をマーク
                markCalendar(afterHolsStartDate, afterHolsEndDate, "#90EE90");
                $('afterholsLabel').style.backgroundColor = "#90EE90";
            }

            //無給期間をマーク
            if (diff > 7) markCalendar(noPayStartDate, noPayEndDate, "#FCF");

        }

        function markCalendar(s, e, c) {
            for (i = s; DateDiff("d", i, e) >= 0; i = DateAdd('d', 1, i, "yyyy/mm/dd")) {
                var id = getId(i.split("/"));
                $(id).style.backgroundColor = c;
                //new Effect.Highlight(id,{restorecolor:c});
            }
        }

        function showMessage(e, m) {
            $(e).innerHTML = '<div>' + m + '<\/div>';
            Element.show(e);
        }

        function hideMessage(e) {
            $(e).innerHTML = "&nbsp;";
            Element.hide(e);
        }

        function getDueDate(d) {
            return [formatNum($F('dueYear'), 4), formatNum($F('dueMonth'), 2), formatNum($F('dueDay'), 2)].join(d)
        };

        function getDeliveryDate(d) {
            return [formatNum($F('deliveryYear'), 4), formatNum($F('deliveryMonth'), 2), formatNum($F('deliveryDay'), 2)].join(d)
        };

        function toJ() {
            if (arguments[0].indexOf('/') > 0) {
                var ymd = arguments[0].split('/');
                return ymd[0] + "年" + ymd[1] + "月" + ymd[2] + "日";
            } else {
                return argument[0] + "年" + argument[1] + "月" + argument[2] + "日";
            }

        }

        function getCalendar(y, m, column) {
            var weekDay = new Array("日", "月", "火", "水", "木", "金", "土");
            var wrtColor = new Array("#FF0000", "#000000", "#000000", "#000000", "#000000", "#000000", "#0000FF");
            var specCol = "#FF0000"; //　休日の文字色

            var theDate = new Date(); //　日付オブジェクトを生成
            theDate.setYear(y); //　指定年を設定
            theDate.setDate(1); //　日付を１日にし曜日を次の行で取得 *2013.2.19 update 先に日付を設定しないと31日で結果が翌月の末日がかえってしまう
            theDate.setMonth(m - 1); //　指定月を設定

            var eday = parseInt(((EDate([y, m, 1].join("/"), 'yyyy/m/d')).split('/'))[2], 10);
            var wday = theDate.getDay();
            var filler = wday; //　曜日カウンタを0にする
            var date = 1; //　日付を1日にする
            var i, j;
            var calendar = "";

            if (column % 3 == 0) calendar += "<div style='clear:both'><\/div>";
            calendar += "<table class='calendar'><tr><th colspan=7>" + y + "年" + m + "月<\/th><\/tr>";
            //曜日行
            calendar += "<tr>";
            for (i = 0; i < 7; i++) calendar += "<th>" + weekDay[i] + "<\/th>";
            calendar += "<\/tr><tr>";

            //filler
            for (i = 0; i != filler; i++) calendar += "<td>&nbsp;<\/td>";

            for (i = 1; i <= eday; i++) {
                var myid = getId(y, m, date);
                var myclass = "w";

                if (wday % 7 == 6) myclass = "sat";
                else if (wday % 7 == 0) myclass = "sun";

                calendar += getCalendarTd(date, myid, myclass);

                if (wday % 7 == 6) calendar += "<\/tr><tr>";
                date++;
                wday++;
            }

            //filler
            for (i = wday - 1; i % 7 != 6; i++) calendar += "<td>&nbsp;<\/td>";

            calendar += "<\/tr><\/table>";

            return calendar;
        }

        function getCalendarTd(d, i, c) {
            return "<td id='" + i + "' class='" + c + "'>" + d + "<\/td>";
        }

        function getId(y, m, d) {
            if (y instanceof Array) {
                d = y[2];
                m = y[1];
                y = y[0];
            }
            return "" + formatNum(y, 4) + formatNum(m, 2) + formatNum(d, 2);
        }

        function formatNum(i, l) {
            while (i.toString().length < l) {
                i = "0" + i;
            }
            return i;
        }

        function hideMessageArea() {
            new Element.hide('messageArea')
        }

        function showMessageArea() {
            new Element.show('messageArea')
        }
        window.onload = initForm;
        //]]>
    </script>
</head>

<body>
    <noscript>
<span class="alert">※Javascriptを有効にしてください。</span>
</noscript>
    <form name="myForm" id="myForm" action="">
        <div id="inputArea">
            <p>産前休務、産後休務をカレンダー表示します。<br />出産予定日(出産日)を入力して「カレンダー表示」をクリックしてください。</p>
            <!-- 出産予定日 -->
            <div class="row" style="border:3px solid #FF8C00;background-color:#F4F4F4;">
                <label class="column1">出産予定日：</label>
                <span id="dueDate" class="column2">
<select id="dueYear" name="dueYear" onchange="setDaySelectOptions('dueDay');toggleDeliveryDateSameAsDueDate();">
  <option value="0">0</option>
</select>
<select id="dueMonth" name="dueMonth" onChange="setDaySelectOptions('dueDay');toggleDeliveryDateSameAsDueDate();">
<option value="0">0</option>
</select>
<select id="dueDay" name="dueDay" onChange="toggleDeliveryDateSameAsDueDate();">
<option value="0">0</option>
</select>
<input type="checkbox" id="multiDelivery" name="multiDelivery" value="1" />多胎出産</span>
            </div>
            <!-- 出産日 -->
            <div class="row" style="border:3px solid #F00;background-color:#F4F4F4;">
                <label class="column1">出産日：</label>
                <span id="deliveryDate" class="column2">
<select id="deliveryYear" name="deliveryYear" onChange="setDaySelectOptions('deliveryDay');">
<option value="0">0</option>
</select>
<select id="deliveryMonth" name="deliveryMonth" onChange="setDaySelectOptions('deliveryDay');">
<option value="0">0</option>
</select>
<select id="deliveryDay" name="deliveryDay">
<option value="0">0</option>
</select>
<input type="checkbox" id="sameAsDueDate" name="sameAsDueDate" value="1" onClick="toggleDeliveryDateSameAsDueDate()" checked=1 />予定日と同じ
</span>
            </div>
            <div style="margin:14px;"></div>
            <div style="text-align:right;"><a href="#" id="myButton" onClick="calcHols()">&nbsp;&raquo;&nbsp;&nbsp;カレンダー表示&nbsp;</a></div>
        </div>

        <div id="messageArea">
            <!-- 産前休暇期間 -->
            <div class="row" style="border:3px solid #DDD;background-color:#F4F4F4;padding:0;height:1.5em;">
                <label class="column1" id="boforeholsLabel">産前休務：</label>
                <span id="beforeHols" class="column2">*********</span>
            </div>
            <!-- 産後休暇期間 -->
            <div class="row" style="border:3px solid #DDD;background-color:#F4F4F4;padding:0;height:1.5em;">
                <label class="column1" id="afterholsLabel">産後休務：</label>
                <span id="afterHols" class="column2">********</span>
            </div>
            <div style="clear:both;"></div>
            <!-- メッセージ -->
            <div id="beforeHolsMessage" class="column1"></div>
            <div id="afterHolsMessage" class="column1"></div>
            <!-- カレンダー  -->
            <div id="calendar"></div>
            <div style="padding:4px;width:500px;">
                <p class="style1" style="margin:0; padding-left:1em; text-indent:-1em;">※出産日が出産予定日より早くなった場合、健康保険組合の「被保険者出産手当金請求書」に記載する「産前産後休暇期間」は、本システムで算出された産前産後休務期間と異なりますのでご注意下さい。</p>
            </div>
            <div style="clear:both;"></div>
        </div>
        <div style="text-align:center;padding:4px;width:500px;"><a href="#" style="background-color:#AAB;color:#000" onClick="self.close()">閉じる</a></div>
        <div style="clear:both;"></div>
    </form>
</body>

</html>