<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <title>産前産後休務カレンダー</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
</head>

<body>
    <div id="app">
        <v-app>
            <v-main>
                <v-container>
                    <v-card class="mx-auto" max-width="750" cols="12" sm="6" md="4" lg="3">
                        <v-card-subtitle class="pb-2">出産手当金</v-card-subtitle>
                        <v-card-text class="text-h5 font-weight-bold">産前・産後期間計算ツール</v-card-text>
                        <v-card-subtitle>単体、多胎妊娠の別、出産予定日、出生日を入力してください。産前・産後期間を表示します。</strong>
                        </v-card-subtitle>
                        <v-card-text>
                            <v-form ref="form" v-model="valid" lazy-validation>
                                <v-row>
                                    <v-col cols="12" sm="12" md="12" lg="12" class="pb-0 pt-0 pt-sm-4 pt-md-1 pt-lg-4">
                                        <v-radio-group v-model="pregnancy" @change="getCalendar()" row>
                                            <v-radio label="単体妊娠" :value="false"></v-radio>
                                            <v-radio label="多胎妊娠（双子、三つ子以上）" :value="true"></v-radio>
                                        </v-radio-group>
                                    </v-col>
                                    <v-col cols="12" sm="12" md="12" lg="12" class="py-0">
                                        <v-menu ref="menu" v-model="menu" :close-on-content-click="false" :return-value.sync="expectedDate" transition="scale-transition" offset-y min-width="auto">
                                            <template v-slot:activator="{ on, attrs }">
                                <v-text-field
                                  v-model="expectedDate"
                                  label="出産予定日"
                                  prepend-icon="mdi-calendar"
                                  readonly
                                  v-bind="attrs"
                                  v-on="on"
                                  :rules="[v => !!v || '日付を選択してください']"
                                  required
                                ></v-text-field>
                              </template>
                                            <v-date-picker :show-current="false" v-model="expectedDate" no-title scrollable locale="ja-jp" :day-format="dayFormat">
                                                <v-spacer></v-spacer>
                                                <v-btn text color="primary" @click="menu = false">
                                                    キャンセル
                                                </v-btn>
                                                <v-btn text color="primary" @click="saveExpectedDate(expectedDate)">
                                                    OK
                                                </v-btn>
                                            </v-date-picker>
                                        </v-menu>
                                    </v-col>
                                    <v-col cols="12" sm="12" md="12" lg="12" class="py-0">
                                        <v-menu ref="menu2" v-model="menu2" :close-on-content-click="false" :return-value.sync="birthDate" transition="scale-transition" offset-y min-width="auto">
                                            <template v-slot:activator="{ on, attrs }">
                                <v-text-field
                                  v-model="birthDate"
                                  label="出生日"
                                  prepend-icon="mdi-calendar"
                                  readonly
                                  v-bind="attrs"
                                  v-on="on"
                                  :rules="[isValidBirthDate, isValidBirthDate2]"
                                  :disabled="false"
                                ></v-text-field>
                              </template>
                                            <v-date-picker :show-current="false" v-model="birthDate" no-title scrollable locale="ja-jp" :day-format="dayFormat">
                                                <v-spacer></v-spacer>
                                                <v-btn text color="primary" @click="menu2 = false">
                                                    キャンセル
                                                </v-btn>
                                                <v-btn text color="primary" @click="saveBirthDate(birthDate)">
                                                    OK
                                                </v-btn>
                                            </v-date-picker>
                                        </v-menu>
                                    </v-col>
                                    <v-col cols="12" sm="12" md="12" lg="12" class="pt-0 pt-md-4">
                                        <v-checkbox v-model="onSchedule" label="予定日と同じ" @click="syncDate"></v-checkbox>
                                    </v-col>
                                </v-row>
                            </v-form>
                        </v-card-text>
                    </v-card>

                    <v-card v-if="months.length > 0 && valid" class="mt-4 mx-auto" max-width="750" cols="12" sm="6" md="4" lg="3">
                        <v-system-bar color="indigo" dark>
                            <v-icon class="ml-4">mdi-calendar</v-icon>
                            計算結果
                            <v-spacer></v-spacer>
                            <v-icon @click="onEscKeyDown">mdi-close</v-icon>
                        </v-system-bar>
                        <v-card-text>
                            <v-row>
                                <v-col v-show="message == 1">出産日が予定日より1 週間以上遅れた場合は、1週間を超える期間については無給となります。</v-col>
                                <v-col v-show="message == 2">妊娠４カ月未満で早産、流産や人工妊娠中絶を行ったときは、<span style='background-color:#FA8072;'>その当日</span>を産前休暇として取ることができます。また、その日から<span style='background-color:#00BFFF;'>６週間以内で医師が必要と認めた期間</span>を産後休暇として取ることができます。</v-col>
                                <v-col v-show="message == 3">
                                    予定日の６週間前になるまでに出産したときは<span style='background-color:#FA8072;'>出産当日と出産日前で医師が休養を必要と認めた期間（最大６週間）</span>を産前休暇として取ることができます。
                                </v-col>
                            </v-row>
                            <v-row v-show="debug">
                                <v-col>expectedDate: {{ expectedDate }}</v-col>
                                <v-col>birthDate: {{ birthDate }}</v-col>
                                <v-col>preStartDate: {{ preStartDate.format("yyyy-MM-DD") }}</v-col>
                                <v-col>preEndDate: {{ preEndDate.format("yyyy-MM-DD") }}</v-col>
                                <v-col>postStartDate: {{ postStartDate.format("yyyy-MM-DD") }}</v-col>
                                <v-col>postEndDate: {{ postEndDate .format("yyyy-MM-DD") }}</v-col>
                                <v-col>benefitDays: {{ benefitDays }}</v-col>
                            </v-row>
                            <v-row class="justify-space-between">
                                <v-col class="col-auto font-weight-bold">
                                    <v-chip class="indigo" dark>支給開始日</v-chip>
                                </v-col>
                                <v-col class="col-auto font-weight-bold align-end text-h5">{{ preStartDate.format('yyyy年M月D日') }}
                                </v-col>
                            </v-row>
                            <v-row>
                                <v-divider></v-divider>
                            </v-row>
                            <v-row class="justify-space-between">
                                <v-col class="col-auto font-weight-bold">
                                    <v-chip class="indigo" dark>支給満了日</v-chip>
                                </v-col>
                                <v-col class="col-auto font-weight-bold align-end text-h5">{{ postEndDate.format('yyyy年M月D日') }}
                                </v-col>
                            </v-row>
                            <v-row>
                                <v-divider></v-divider>
                            </v-row>
                            <v-row class="justify-space-between">
                                <v-col class="col-auto font-weight-bold">
                                    <v-chip class="indigo" dark>支給期間</v-chip>
                                </v-col>
                                <v-col class="col-auto font-weight-bold align-end text-h5">{{ benefitDays }} 日間<span v-if="extendedDays> 0">（延長期間：{{ extendedDays }}日）</span>
                                </v-col>
                            </v-row>
                            <v-row>
                                <v-divider></v-divider>
                            </v-row>
                            <v-row class="justify-space-between">
                                <v-col class="col-auto font-weight-bold">
                                    <v-chip class="indigo" dark>育児休業開始日</v-chip>
                                </v-col>
                                <v-col class="col-auto font-weight-bold align-end text-h5">{{ leaveStart.format('yyyy年M月D日') }}
                                </v-col>
                            </v-row>
                        </v-card-text>
                    </v-card>
                    <v-expand-transition>
                        <v-card v-if="months.length > 0 && valid" class="mt-4 mx-auto" max-width="750" cols="12" sm="6" md="4" lg="3">
                            <v-card-text>
                                <v-row>
                                    <v-col>
                                        <v-btn target="gcal" :href="gcalUrl">
                                            <v-icon left>mdi-calendar</v-icon>Googleカレンダーに登録</v-btn>
                                    </v-col>
                                    <v-col align="right">
                                        <v-chip color="primary" class="mr-2">産前</v-chip>
                                        <v-chip color="success">産後</v-chip>
                                    </v-col>
                                </v-row>
                                <v-row>
                                    <v-col v-for="m in months" :key="m.key" cols="12" sm="6" md="6" lg="6" xl="6">
                                        <v-card>
                                            <v-card-title>
                                                <v-row>
                                                    <v-col class="text-center">{{m.label}}</v-col>
                                                </v-row>
                                            </v-card-title>
                                            <v-card-text>
                                                <v-calendar ref="calendar" locale="ja-jp" :events="events" event-overlap-mode="column" :event-more="false" :value="m.value" readonly="true" :event-color="getEventColor">
                                                    <template v-slot:day-label="{date}">
                                      <v-btn x-small fab depressed :color="getDayColor(date)" @click="setDates(date)">{{dayFormat(date)}}</v-btn>
                                    </template>
                                                </v-calendar>
                                            </v-card-text>
                                        </v-card>
                                    </v-col>
                                </v-row>
                            </v-card-text>
                        </v-card>
                    </v-expand-transition>
                </v-container>
            </v-main>
        </v-app>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.3/moment.min.js" type="text/javascript"></script>
    <script>
        Vue.config.devtools = true;
        new Vue({
            el: '#app',
            vuetify: new Vuetify(),
            data: () => ({
                valid: false,
                debug: false,
                pregnancy: false,
                expectedDate: null,
                birthDate: null,
                onSchedule: true,
                menu: false,
                menu2: false,
                months: [],
                events: [],
                preStartDate: null,
                preEndDate: null,
                postStartDate: null,
                postEndDate: null,
                extended: 0,
                benefitDays: 0,
                extendedDays: 0,
                leaveStart: null,
                leaveEnd: null,
                message: 0,
                gcalUrl: ""
            }),
            methods: {
                setDates(date) {
                    if (this.onSchedule) {
                        this.expectedDate = date;
                        this.saveExpectedDate(date);
                    } else {
                        this.birthDate = date;
                        this.saveBirthDate(date);
                    }
                },
                saveExpectedDate(date) {
                    this.$refs.menu.save(date)
                    if (this.onSchedule) {
                        this.birthDate = this.expectedDate;
                    }
                    this.getCalendar();
                    this.$refs.form.validate();
                },
                saveBirthDate(date) {
                    this.$refs.menu2.save(date);
                    if (this.expectedDate == this.birthDate) {
                        this.onSchedule = true;
                    } else {
                        this.onSchedule = false;
                    }
                    this.$refs.form.validate();
                    this.getCalendar();
                },
                isValidBirthDate(v) {
                    return (moment(this.expectedDate).diff(moment(v), 'days') > -30) || '日付を確認してください'
                },
                isValidBirthDate2(v) {
                    return (moment(this.expectedDate).diff(moment(v), 'days') < 280) || '日付を確認してください'
                },
                syncDate() {
                    if (this.onSchedule) {
                        this.$refs.menu2.save(this.expectedDate);
                        this.birthDate = this.expectedDate;
                    }
                    this.getCalendar();
                },
                getCalendar() {
                    // return if condition is invalid.
                    if (!this.expectedDate || !this.valid) {
                        this.months = [];
                        return;
                    }

                    // calc pre post dates
                    const weeks = this.pregnancy ? 14 : 6;
                    const days = (weeks * 7 - 1);
                    this.preStartDate = moment(this.expectedDate).subtract(days, 'days');
                    this.preEndDate = moment(this.birthDate);
                    this.postStartDate = moment(this.birthDate).add(1, 'days');
                    this.postEndDate = moment(this.birthDate).add({
                        weeks: 8
                    })

                    // check the diff of the birthday and expected day. 
                    const e = moment(this.expectedDate);
                    const b = moment(this.birthDate);
                    const diff = e.diff(b, 'days');
                    if (diff < -7) { // 一週間以上後
                        this.message = 1;
                    } else if (diff > 7 * 4 * 7) { //在胎4ヶ月未満
                        //産後休暇は6週間で医師が必要と認めた期間
                        //afterHolsEndDate = DateAdd('d', 7 * (afterHolsWeeks - 2) - 1, afterHolsStartDate, "yyyy/mm/dd");
                        this.preStartDate = moment(this.birthDate);
                        this.message = 2;
                    } else if (diff >= 7 * 6) { //在胎４カ月以後、6週間より前
                        //beforeHolsWeeks = 6; //多胎の場合でも単胎と同じになる
                        //beforeHolsStartDate = DateAdd('d', -7 * beforeHolsWeeks + 1, getDeliveryDate("/"), "yyyy/mm/dd");
                        //beforeHolsEndDate = getDeliveryDate("/");
                        this.preStartDate = moment(this.birthDate);
                        this.message = 3;
                    } else {
                        this.message = 0;
                    }
                    this.extended = moment(this.birthDate).diff(moment(this.expectedDate), 'days');
                    if (this.extended < 0) {
                        this.extended = 0;
                    }
                    this.benefitDays = this.postEndDate.diff(this.preStartDate, 'days') + 1;
                    this.extendedDays = moment(this.birthDate).diff(moment(this.expectedDate), 'days');
                    this.leaveStart = this.postEndDate.clone()
                    this.leaveStart.add(1, 'days');
                    this.leaveEnd = this.leaveStart.clone();
                    this.leaveEnd.add(1, 'years');
                    this.months = this.getMonths();
                    this.events = this.getEvents();
                    this.gcalUrl = "https://calendar.google.com/calendar/u/0/r/eventedit?text=%E5%87%BA%E7%94%A3%E6%89%8B%E5%BD%93%E9%87%91%E6%94%AF%E7%B5%A6%E6%9C%9F%E9%96%93&dates=" + this.preStartDate.format('yyyyMMDD') + "/" + this.leaveStart.format('yyyyMMDD');
                },
                getMonths() {
                    const months = [];
                    const a = this.preStartDate.clone();
                    const b = moment(this.birthDate);
                    const dateStart = a.isSameOrBefore(b) ? a : b;
                    const dateEnd = moment(this.postEndDate);
                    dateStart.set('date', 1);
                    dateEnd.set('date', 1);
                    while (dateStart.diff(dateEnd, "months") < 1) {
                        months.push({
                            key: dateStart.format('M'),
                            value: dateStart.format('yyyy-MM-DD'),
                            label: dateStart.format('M月')
                        });
                        dateStart.add(1, 'month')
                    }
                    return months;
                },
                getEvents() {
                    const events = [];
                    events.push({
                        name: '開始日',
                        start: this.preStartDate.format('yyyy-MM-DD'),
                        end: null,
                        timed: false,
                        color: '#f00'
                    });
                    events.push({
                        name: '満了日',
                        start: this.postEndDate.format('yyyy-MM-DD'),
                        end: null,
                        timed: false,
                        color: '#f00'
                    });
                    events.push({
                        name: '予定日',
                        start: this.expectedDate,
                        end: null,
                        timed: false,
                        color: '#f00'
                    });
                    if (!this.onSchedule) {
                        events.push({
                            name: '出生日',
                            start: this.birthDate,
                            end: null,
                            timed: false,
                            color: '#f90'
                        });
                    }
                    return events;
                },
                getEventColor(event) {
                    return event.color;
                },
                dayFormat(date) {
                    return new Date(date).getDate()
                },
                getDayColor(date) {
                    const d = moment(date);
                    if (d.isSameOrAfter(this.preStartDate) && d.isSameOrBefore(this.preEndDate)) {
                        return 'primary';
                    } else if (d.isSameOrAfter(this.postStartDate) && d.isSameOrBefore(this.postEndDate)) {
                        return 'success';
                    } else {
                        return 'white';
                    }
                },
                onEscKeyDown() {
                    this.$refs.form.reset();
                    this.$nextTick(() => {
                        this.expectedDate = null;
                        this.birthDate = null;
                        this.pregnancy = false;
                        this.onSchedule = true;
                    })
                },
            }
        })
    </script>
    <style>
        #app {
            background: #f9f9f9;
        }
        
        .theme--light.v-calendar-weekly .v-calendar-weekly__head-weekday,
        .theme--light.v-calendar-weekly,
        .theme--light.v-calendar-weekly .v-calendar-weekly__day {
            border: none;
        }
        
        .theme--light.v-calendar-weekly .v-calendar-weekly__head-weekday.v-outside,
        .theme--light.v-calendar-weekly .v-calendar-weekly__day.v-outside {
            background-color: transparent;
        }
        
        .theme--light.v-calendar-weekly .v-calendar-weekly__head-weekday.v-past {
            color: #333;
        }
        
        .v-outside .v-event,
        .v-outside .v-btn {
            display: none;
        }
        
        .v-calendar .v-event {
            margin-top: -6px;
        }
    </style>
</body>

</html>